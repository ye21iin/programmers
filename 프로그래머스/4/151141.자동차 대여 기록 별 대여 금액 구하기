SELECT HISTORY_ID, FEE
FROM (SELECT
    ONE.HISTORY_ID,
    CASE WHEN TWO.DISCOUNT_RATE IS NULL
    THEN ONE.DURATION * ONE.DAILY_FEE
    ELSE ONE.DURATION * ONE.DAILY_FEE * ((100 - TWO.DISCOUNT_RATE) / 100)
    END AS FEE,
    ROW_NUMBER() OVER (
            PARTITION BY ONE.HISTORY_ID 
            ORDER BY TWO.LENGTH DESC
        ) AS RN
FROM (SELECT 
    H.HISTORY_ID,
    H.END_DATE - H.START_DATE + 1 AS DURATION,
    C.DAILY_FEE
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
JOIN CAR_RENTAL_COMPANY_CAR C ON H.CAR_ID = C.CAR_ID AND C.CAR_TYPE = '트럭'
) ONE
LEFT JOIN (SELECT 
    TO_NUMBER(REPLACE(DURATION_TYPE,SUBSTR(DURATION_TYPE,-4),'')) AS LENGTH, DISCOUNT_RATE
FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
WHERE CAR_TYPE = '트럭') TWO ON ONE.DURATION >= TWO.LENGTH
) WHERE RN = 1
ORDER BY 2 DESC, 1 DESC
