WITH CalculatedFee AS (
    SELECT
        C.CAR_ID,
        C.CAR_TYPE,
        (C.DAILY_FEE * (1 - P.DISCOUNT_RATE / 100.0) * 30) AS FEE
    FROM
        CAR_RENTAL_COMPANY_CAR C
    JOIN
        CAR_RENTAL_COMPANY_DISCOUNT_PLAN P ON C.CAR_TYPE = P.CAR_TYPE AND P.DURATION_TYPE = '30일 이상'
    WHERE
        C.CAR_TYPE IN ('세단', 'SUV')
)
SELECT
    CF.CAR_ID,
    CF.CAR_TYPE,
    CF.FEE
FROM
    CalculatedFee CF
WHERE
    CF.FEE BETWEEN 500000 AND 1999999
    AND NOT EXISTS (
        SELECT 1
        FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY RH
        WHERE RH.CAR_ID = CF.CAR_ID
          AND RH.START_DATE <= TO_DATE('2022-11-30', 'YYYY-MM-DD')
          AND RH.END_DATE >= TO_DATE('2022-11-01', 'YYYY-MM-DD')
    )
ORDER BY
    CF.FEE DESC, CF.CAR_TYPE ASC, CF.CAR_ID DESC;
