WITH RESULT AS (
    SELECT E.EMP_NO, AVG(G.SCORE) AS MEAN
    FROM HR_EMPLOYEES E
    JOIN HR_GRADE G ON E.EMP_NO = G.EMP_NO
    GROUP BY E.EMP_NO
)

SELECT
    R.EMP_NO,
    E.EMP_NAME,
    CASE WHEN R.MEAN >= 96 THEN 'S'
    WHEN R.MEAN >= 90 THEN 'A'
    WHEN R.MEAN >= 80 THEN 'B'
    ELSE 'C'
    END AS GRADE,
    (CASE WHEN R.MEAN >= 96 THEN 0.2
     WHEN R.MEAN >= 90 THEN 0.15
     WHEN R.MEAN >= 80 THEN 0.1
     ELSE 0
    END) * E.SAL AS BONUS
FROM RESULT R
JOIN HR_EMPLOYEES E ON R.EMP_NO = E.EMP_NO
ORDER BY 1
